#!/usr/bin/env node

/**
 * URL Shortening Service Test Suite
 * Tests all API endpoints and database functionality
 */

const http = require('http');

const BASE_URL = process.env.TEST_URL || 'http://localhost:8080';
const TEST_SHORT_CODE = 'test' + Date.now();

// ANSI color codes
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  cyan: '\x1b[36m',
  gray: '\x1b[90m'
};

// Test results
let passed = 0;
let failed = 0;
const results = [];

// Helper: Make HTTP request
function request(method, path, data = null) {
  return new Promise((resolve, reject) => {
    const url = new URL(path, BASE_URL);
    const options = {
      method,
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'QRGen-Test-Suite/1.0'
      }
    };

    const req = http.request(url, options, (res) => {
      let body = '';
      res.on('data', chunk => body += chunk);
      res.on('end', () => {
        try {
          const json = body ? JSON.parse(body) : {};
          resolve({ status: res.statusCode, headers: res.headers, body: json });
        } catch (e) {
          resolve({ status: res.statusCode, headers: res.headers, body });
        }
      });
    });

    req.on('error', reject);
    
    if (data) {
      req.write(JSON.stringify(data));
    }
    
    req.end();
  });
}

// Helper: Test assertion
function assert(condition, message) {
  if (condition) {
    passed++;
    console.log(`${colors.green}✓${colors.reset} ${message}`);
    results.push({ status: 'PASS', test: message });
  } else {
    failed++;
    console.log(`${colors.red}✗${colors.reset} ${message}`);
    results.push({ status: 'FAIL', test: message });
  }
}

// Helper: Test section header
function section(title) {
  console.log(`\n${colors.cyan}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${colors.reset}`);
  console.log(`${colors.cyan}${title}${colors.reset}`);
  console.log(`${colors.cyan}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${colors.reset}`);
}

// Test: Health Check
async function testHealthCheck() {
  section('Test 1: Health Check');
  
  try {
    const res = await request('GET', '/health');
    
    assert(res.status === 200, 'Health endpoint returns 200 OK');
    assert(res.body.status === 'healthy', 'Health status is healthy');
    assert(res.body.database === 'connected', 'Database is connected');
    assert(typeof res.body.uptime === 'number', 'Uptime is a number');
    assert(res.body.timestamp !== undefined, 'Timestamp is present');
    
    console.log(`${colors.gray}  Status: ${res.body.status}${colors.reset}`);
    console.log(`${colors.gray}  Database: ${res.body.database}${colors.reset}`);
    console.log(`${colors.gray}  Uptime: ${res.body.uptime.toFixed(2)}s${colors.reset}`);
  } catch (error) {
    assert(false, `Health check failed: ${error.message}`);
  }
}

// Test: Create Short URL
async function testCreateShortUrl() {
  section('Test 2: Create Short URL');
  
  try {
    const testUrl = 'https://example.com/test-page-' + Date.now();
    const res = await request('POST', '/api/shorten', {
      url: testUrl,
      shortCode: TEST_SHORT_CODE,
      metadata: {
        test: true,
        campaign: 'test-suite'
      }
    });
    
    assert(res.status === 200, 'Create endpoint returns 200 OK');
    assert(res.body.success === true, 'Response indicates success');
    assert(res.body.shortCode === TEST_SHORT_CODE, 'Short code matches request');
    assert(res.body.originalUrl === testUrl, 'Original URL matches request');
    assert(res.body.shortUrl.includes(TEST_SHORT_CODE), 'Short URL contains code');
    assert(res.body.createdAt !== undefined, 'Created timestamp is present');
    
    console.log(`${colors.gray}  Short Code: ${res.body.shortCode}${colors.reset}`);
    console.log(`${colors.gray}  Short URL: ${res.body.shortUrl}${colors.reset}`);
    console.log(`${colors.gray}  Original URL: ${res.body.originalUrl}${colors.reset}`);
    
    return res.body;
  } catch (error) {
    assert(false, `Create short URL failed: ${error.message}`);
  }
}

// Test: Create Short URL with Auto-Generated Code
async function testAutoGeneratedCode() {
  section('Test 3: Auto-Generated Short Code');
  
  try {
    const testUrl = 'https://example.com/auto-generated-' + Date.now();
    const res = await request('POST', '/api/shorten', {
      url: testUrl
      // No shortCode provided - should auto-generate
    });
    
    assert(res.status === 200, 'Create endpoint returns 200 OK');
    assert(res.body.success === true, 'Response indicates success');
    assert(res.body.shortCode !== undefined, 'Short code was auto-generated');
    assert(res.body.shortCode.length >= 6, 'Generated code is at least 6 chars');
    assert(/^[a-z0-9]+$/.test(res.body.shortCode), 'Generated code is alphanumeric');
    
    console.log(`${colors.gray}  Generated Code: ${res.body.shortCode}${colors.reset}`);
    console.log(`${colors.gray}  Short URL: ${res.body.shortUrl}${colors.reset}`);
  } catch (error) {
    assert(false, `Auto-generated code failed: ${error.message}`);
  }
}

// Test: Invalid URL Validation
async function testInvalidUrl() {
  section('Test 4: Invalid URL Validation');
  
  try {
    const res = await request('POST', '/api/shorten', {
      url: 'not-a-valid-url'
    });
    
    assert(res.status === 400, 'Invalid URL returns 400 Bad Request');
    assert(res.body.error !== undefined, 'Error message is provided');
    
    console.log(`${colors.gray}  Error: ${res.body.error}${colors.reset}`);
  } catch (error) {
    assert(false, `Invalid URL test failed: ${error.message}`);
  }
}

// Test: Duplicate Short Code
async function testDuplicateCode() {
  section('Test 5: Duplicate Short Code');
  
  try {
    const res = await request('POST', '/api/shorten', {
      url: 'https://example.com/duplicate-test',
      shortCode: TEST_SHORT_CODE // Already exists from Test 2
    });
    
    assert(res.status === 400, 'Duplicate code returns 400 Bad Request');
    assert(res.body.error !== undefined, 'Error message is provided');
    assert(res.body.error.includes('exists'), 'Error mentions existing code');
    
    console.log(`${colors.gray}  Error: ${res.body.error}${colors.reset}`);
  } catch (error) {
    assert(false, `Duplicate code test failed: ${error.message}`);
  }
}

// Test: Redirect and Visit Tracking
async function testRedirectAndTracking() {
  section('Test 6: Redirect and Visit Tracking');
  
  try {
    // Make a request to the short URL
    const url = new URL(`/${TEST_SHORT_CODE}`, BASE_URL);
    const options = {
      method: 'GET',
      headers: {
        'User-Agent': 'QRGen-Test-Suite/1.0',
        'Referer': 'https://github.com/test-referrer'
      }
    };
    
    const res = await new Promise((resolve, reject) => {
      const req = http.request(url, options, (res) => {
        // Don't follow redirects - just check the response
        resolve(res);
      });
      req.on('error', reject);
      req.end();
    });
    
    assert(res.statusCode === 301, 'Redirect returns 301 Permanent');
    assert(res.headers.location !== undefined, 'Location header is present');
    assert(res.headers.location.includes('example.com'), 'Redirects to correct URL');
    
    console.log(`${colors.gray}  Status: ${res.statusCode}${colors.reset}`);
    console.log(`${colors.gray}  Location: ${res.headers.location}${colors.reset}`);
    
    // Wait a moment for visit to be recorded
    await new Promise(resolve => setTimeout(resolve, 100));
  } catch (error) {
    assert(false, `Redirect test failed: ${error.message}`);
  }
}

// Test: Get Statistics
async function testGetStatistics() {
  section('Test 7: Get Statistics');
  
  try {
    const res = await request('GET', `/api/stats/${TEST_SHORT_CODE}`);
    
    assert(res.status === 200, 'Stats endpoint returns 200 OK');
    assert(res.body.success === true, 'Response indicates success');
    assert(res.body.stats !== undefined, 'Stats object is present');
    assert(res.body.stats.short_code === TEST_SHORT_CODE, 'Correct short code in stats');
    assert(res.body.stats.total_visits >= 1, 'At least one visit recorded');
    assert(res.body.referrers !== undefined, 'Referrers array is present');
    assert(Array.isArray(res.body.referrers), 'Referrers is an array');
    
    console.log(`${colors.gray}  Total Visits: ${res.body.stats.total_visits}${colors.reset}`);
    console.log(`${colors.gray}  Unique Visitors: ${res.body.stats.unique_visitors}${colors.reset}`);
    console.log(`${colors.gray}  Unique Referrers: ${res.body.stats.unique_referrers}${colors.reset}`);
    
    if (res.body.referrers.length > 0) {
      console.log(`${colors.gray}  Top Referrer: ${res.body.referrers[0].referrer_domain} (${res.body.referrers[0].visit_count} visits)${colors.reset}`);
    }
  } catch (error) {
    assert(false, `Get statistics failed: ${error.message}`);
  }
}

// Test: Non-Existent Short Code
async function testNonExistentCode() {
  section('Test 8: Non-Existent Short Code');
  
  try {
    const res = await request('GET', '/api/stats/nonexistent123456');
    
    assert(res.status === 404, 'Non-existent code returns 404 Not Found');
    assert(res.body.error !== undefined, 'Error message is provided');
    
    console.log(`${colors.gray}  Error: ${res.body.error}${colors.reset}`);
  } catch (error) {
    assert(false, `Non-existent code test failed: ${error.message}`);
  }
}

// Test: Get Popular URLs
async function testPopularUrls() {
  section('Test 9: Get Popular URLs');
  
  try {
    const res = await request('GET', '/api/urls/popular?limit=5');
    
    assert(res.status === 200, 'Popular URLs endpoint returns 200 OK');
    assert(res.body.success === true, 'Response indicates success');
    assert(Array.isArray(res.body.data), 'Data is an array');
    assert(res.body.data.length > 0, 'At least one URL in results');
    
    if (res.body.data.length > 0) {
      const top = res.body.data[0];
      assert(top.short_code !== undefined, 'Short code is present');
      assert(top.total_visits !== undefined, 'Visit count is present');
      
      console.log(`${colors.gray}  Total URLs: ${res.body.data.length}${colors.reset}`);
      console.log(`${colors.gray}  Top URL: ${top.short_code} (${top.total_visits} visits)${colors.reset}`);
    }
  } catch (error) {
    assert(false, `Get popular URLs failed: ${error.message}`);
  }
}

// Test: Get Top Referrers
async function testTopReferrers() {
  section('Test 10: Get Top Referrers');
  
  try {
    const res = await request('GET', '/api/referrers/top?limit=5');
    
    assert(res.status === 200, 'Top referrers endpoint returns 200 OK');
    assert(res.body.success === true, 'Response indicates success');
    assert(Array.isArray(res.body.data), 'Data is an array');
    
    console.log(`${colors.gray}  Total Referrers: ${res.body.data.length}${colors.reset}`);
    
    if (res.body.data.length > 0) {
      const top = res.body.data[0];
      console.log(`${colors.gray}  Top Referrer: ${top.referrer_domain} (${top.total_visits} visits)${colors.reset}`);
    }
  } catch (error) {
    assert(false, `Get top referrers failed: ${error.message}`);
  }
}

// Test: Deactivate Short URL
async function testDeactivateUrl() {
  section('Test 11: Deactivate Short URL');
  
  try {
    const res = await request('DELETE', `/api/shorten/${TEST_SHORT_CODE}`);
    
    assert(res.status === 200, 'Deactivate endpoint returns 200 OK');
    assert(res.body.success === true, 'Response indicates success');
    assert(res.body.message !== undefined, 'Success message is provided');
    
    console.log(`${colors.gray}  Message: ${res.body.message}${colors.reset}`);
    
    // Verify it's actually deactivated
    const redirectRes = await new Promise((resolve) => {
      const url = new URL(`/${TEST_SHORT_CODE}`, BASE_URL);
      const req = http.request(url, (res) => resolve(res));
      req.on('error', () => resolve({ statusCode: 0 }));
      req.end();
    });
    
    assert(redirectRes.statusCode !== 301, 'Deactivated URL no longer redirects');
    console.log(`${colors.gray}  Verified: URL is deactivated${colors.reset}`);
  } catch (error) {
    assert(false, `Deactivate URL failed: ${error.message}`);
  }
}

// Test: API Info
async function testApiInfo() {
  section('Test 12: API Info');
  
  try {
    const res = await request('GET', '/api/info');
    
    assert(res.status === 200, 'API info endpoint returns 200 OK');
    assert(res.body.name !== undefined, 'App name is present');
    assert(res.body.version !== undefined, 'Version is present');
    assert(Array.isArray(res.body.features), 'Features array is present');
    assert(res.body.features.includes('URL Shortening'), 'URL Shortening feature listed');
    
    console.log(`${colors.gray}  Name: ${res.body.name}${colors.reset}`);
    console.log(`${colors.gray}  Version: ${res.body.version}${colors.reset}`);
    console.log(`${colors.gray}  Features: ${res.body.features.join(', ')}${colors.reset}`);
  } catch (error) {
    assert(false, `API info failed: ${error.message}`);
  }
}

// Test Summary
function printSummary() {
  console.log(`\n${colors.cyan}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${colors.reset}`);
  console.log(`${colors.cyan}Test Summary${colors.reset}`);
  console.log(`${colors.cyan}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${colors.reset}`);
  
  const total = passed + failed;
  const percentage = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
  
  console.log(`${colors.green}Passed: ${passed}${colors.reset}`);
  console.log(`${colors.red}Failed: ${failed}${colors.reset}`);
  console.log(`Total: ${total}`);
  console.log(`Success Rate: ${percentage}%`);
  
  if (failed === 0) {
    console.log(`\n${colors.green}✓ All tests passed!${colors.reset}`);
  } else {
    console.log(`\n${colors.red}✗ Some tests failed${colors.reset}`);
    console.log(`\nFailed tests:`);
    results
      .filter(r => r.status === 'FAIL')
      .forEach(r => console.log(`  ${colors.red}✗${colors.reset} ${r.test}`));
  }
  
  console.log(`\n${colors.gray}Testing against: ${BASE_URL}${colors.reset}`);
  console.log(`${colors.cyan}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${colors.reset}\n`);
}

// Main test runner
async function runTests() {
  console.log(`${colors.cyan}╔═══════════════════════════════════════════════╗${colors.reset}`);
  console.log(`${colors.cyan}║  URL Shortening Service - Test Suite         ║${colors.reset}`);
  console.log(`${colors.cyan}╚═══════════════════════════════════════════════╝${colors.reset}`);
  console.log(`\n${colors.gray}Target: ${BASE_URL}${colors.reset}`);
  console.log(`${colors.gray}Started: ${new Date().toISOString()}${colors.reset}\n`);
  
  try {
    await testHealthCheck();
    await testCreateShortUrl();
    await testAutoGeneratedCode();
    await testInvalidUrl();
    await testDuplicateCode();
    await testRedirectAndTracking();
    await testGetStatistics();
    await testNonExistentCode();
    await testPopularUrls();
    await testTopReferrers();
    await testDeactivateUrl();
    await testApiInfo();
  } catch (error) {
    console.error(`\n${colors.red}Fatal error: ${error.message}${colors.reset}`);
    console.error(error.stack);
  }
  
  printSummary();
  
  // Exit with appropriate code
  process.exit(failed > 0 ? 1 : 0);
}

// Run tests
runTests().catch(error => {
  console.error(`${colors.red}Unexpected error: ${error.message}${colors.reset}`);
  process.exit(1);
});
